import cv2
import face_recognition
import os
import csv
import datetime
import numpy as np
from pathlib import Path
import threading
import time
from PIL import ImageFont, ImageDraw, Image

font_path = "C:/Windows/Fonts/malgun.ttf"  # ìœˆë„ìš° ê¸°ë³¸ í•œê¸€ í°íŠ¸

def draw_text_with_pil(img, text, position, font_path, font_size, color):
    img_pil = Image.fromarray(img)
    font = ImageFont.truetype(font_path, font_size)
    draw = ImageDraw.Draw(img_pil)
    draw.text(position, text, font=font, fill=color)
    return np.array(img_pil)

class AttendanceSystem:
    def __init__(self, faces_folder="faces", attendance_file="ì¶œì„ë¶€.csv", 
                 attendance_deadline="09:30", late_deadline="10:00"):
        self.faces_folder = faces_folder
        self.attendance_file = attendance_file
        self.attendance_deadline = attendance_deadline  # ì¶œì„ ë§ˆê°ì‹œê°„ "HH:MM"
        self.late_deadline = late_deadline  # ì§€ê° ë§ˆê°ì‹œê°„ "HH:MM"
        self.known_encodings = []
        self.known_names = []
        
        # ìƒíƒœë³„ë¡œ ë¶„ë¦¬ëœ ì¶œì„ ê´€ë¦¬
        self.present_members = set()  # ì •ì‹œ ì¶œì„ì
        self.late_members = set()     # ì§€ê°ì
        self.absent_members = set()   # ê²°ì„ì (ë§ˆê° í›„ ì¶œì„í•œ ì‚¬ëŒ)
        self.all_checked = set()      # ëª¨ë“  ì¶œì„ ì²´í¬ ì™„ë£Œì (ì¤‘ë³µ ë°©ì§€ìš©)
        
        self.cap = None
        self.running = False
        self.attendance_deadline_passed = False
        self.late_deadline_passed = False
        
        # ì–¼êµ´ ë°ì´í„° ë¡œë“œ
        self.load_known_faces()
        
        # CSV íŒŒì¼ ì´ˆê¸°í™”
        self.init_csv_file()
        
        # í‚¤ ì…ë ¥ì„ ê°ì§€í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
        self.key_pressed = False
        
        # ë§ˆê°ì‹œê°„ë“¤ ì„¤ì •
        self.set_deadlines()
        
        # ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        self.last_update_time = time.time()
    
    def set_deadlines(self):
        """ë‘ ê°œì˜ ë§ˆê° ì‹œê°„ ì„¤ì •"""
        try:
            # ì¶œì„ ë§ˆê°ì‹œê°„
            att_hour, att_minute = map(int, self.attendance_deadline.split(':'))
            today = datetime.date.today()
            self.attendance_deadline_dt = datetime.datetime.combine(
                today, 
                datetime.time(att_hour, att_minute)
            )
            
            # ì§€ê° ë§ˆê°ì‹œê°„
            late_hour, late_minute = map(int, self.late_deadline.split(':'))
            self.late_deadline_dt = datetime.datetime.combine(
                today, 
                datetime.time(late_hour, late_minute)
            )
            
            # ì‹œê°„ ìˆœì„œ í™•ì¸
            if self.attendance_deadline_dt >= self.late_deadline_dt:
                raise ValueError("ì§€ê° ë§ˆê°ì‹œê°„ì€ ì¶œì„ ë§ˆê°ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.")
            
            print(f"ğŸ“… ì¶œì„ ë§ˆê°: {self.attendance_deadline_dt.strftime('%H:%M')}")
            print(f"â° ì§€ê° ë§ˆê°: {self.late_deadline_dt.strftime('%H:%M')}")
            print(f"âŒ {self.late_deadline}ì´í›„: ê²°ì„ ì²˜ë¦¬")
            
        except ValueError as e:
            print(f"ì‹œê°„ ì„¤ì • ì˜¤ë¥˜: {e}")
            print("ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì¶œì„: 09:30, ì§€ê°: 10:00)")
            today = datetime.date.today()
            self.attendance_deadline_dt = datetime.datetime.combine(today, datetime.time(9, 30))
            self.late_deadline_dt = datetime.datetime.combine(today, datetime.time(10, 0))
    
    def get_current_status(self):
        """í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ ë°˜í™˜"""
        now = datetime.datetime.now()
        if now <= self.attendance_deadline_dt:
            return "attendance_time"  # ì¶œì„ ì‹œê°„
        elif now <= self.late_deadline_dt:
            return "late_time"  # ì§€ê° ì‹œê°„
        else:
            return "absent_time"  # ê²°ì„ ì‹œê°„
    
    def get_time_remaining(self):
        """ë‹¤ìŒ ë§ˆê°ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ë°˜í™˜"""
        now = datetime.datetime.now()
        
        if now <= self.attendance_deadline_dt:
            remaining = self.attendance_deadline_dt - now
            target = "ì¶œì„ ë§ˆê°"
        elif now <= self.late_deadline_dt:
            remaining = self.late_deadline_dt - now
            target = "ì§€ê° ë§ˆê°"
        else:
            return "ëª¨ë“  ë§ˆê° ì¢…ë£Œ"
        
        hours = remaining.seconds // 3600
        minutes = (remaining.seconds % 3600) // 60
        
        if remaining.days < 0:
            return "ë§ˆê°ë¨"
        elif remaining.days > 0:
            return f"{target}ê¹Œì§€ {remaining.days}ì¼ {hours:02d}:{minutes:02d}"
        else:
            return f"{target}ê¹Œì§€ {hours:02d}:{minutes:02d}"
    
    def load_known_faces(self):
        """faces í´ë”ì—ì„œ ì–¼êµ´ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ê³  ì¸ì½”ë”©"""
        print("ì–¼êµ´ ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘...")
        
        if not os.path.exists(self.faces_folder):
            print(f"'{self.faces_folder}' í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return
        
        # ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ í™•ì¥ì
        image_extensions = ['.jpg', '.jpeg', '.png', '.bmp']
        
        for filename in os.listdir(self.faces_folder):
            file_path = os.path.join(self.faces_folder, filename)
            
            # ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
            if not any(filename.lower().endswith(ext) for ext in image_extensions):
                continue
            
            try:
                # ì´ë¯¸ì§€ ë¡œë“œ
                image = face_recognition.load_image_file(file_path)
                
                # ì–¼êµ´ ì¸ì½”ë”© (ì²« ë²ˆì§¸ ì–¼êµ´ë§Œ ì‚¬ìš©)
                encodings = face_recognition.face_encodings(image)
                
                if encodings:
                    encoding = encodings[0]
                    # íŒŒì¼ëª…ì—ì„œ í™•ì¥ì ì œê±°í•˜ì—¬ ì´ë¦„ ì¶”ì¶œ
                    name = Path(filename).stem
                    
                    self.known_encodings.append(encoding)
                    self.known_names.append(name)
                    print(f"âœ“ {name} ì–¼êµ´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
                else:
                    print(f"âœ— {filename}ì—ì„œ ì–¼êµ´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    
            except Exception as e:
                print(f"âœ— {filename} ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
        
        print(f"ì´ {len(self.known_names)}ëª…ì˜ ì–¼êµ´ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
        print(f"ë“±ë¡ëœ ë™ì•„ë¦¬ì›: {', '.join(self.known_names)}\n")
    
    def init_csv_file(self):
        """CSV íŒŒì¼ ì´ˆê¸°í™” (í—¤ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±)"""
        if not os.path.exists(self.attendance_file):
            with open(self.attendance_file, 'w', newline='', encoding='utf-8') as file:
                writer = csv.writer(file)
                writer.writerow(['ì´ë¦„', 'ì¶œì„ì‹œê°„', 'ë‚ ì§œ', 'ìƒíƒœ'])
    
    def mark_attendance(self, name):
        """ì¶œì„ ê¸°ë¡"""
        if name not in self.all_checked:
            now = datetime.datetime.now()
            date_str = now.strftime("%Y-%m-%d")
            time_str = now.strftime("%H:%M:%S")
            
            # ì‹œê°„ëŒ€ë³„ ìƒíƒœ ê²°ì •
            current_status = self.get_current_status()
            
            if current_status == "attendance_time":
                status = "ì¶œì„"
                self.present_members.add(name)
                print(f"âœ… {name} ì¶œì„ ì™„ë£Œ! ({time_str})")
            elif current_status == "late_time":
                status = "ì§€ê°"
                self.late_members.add(name)
                print(f"âš ï¸ {name} ì§€ê° ì²˜ë¦¬ë¨! ({time_str})")
            else:  # absent_time
                status = "ê²°ì„"
                self.absent_members.add(name)
                print(f"âŒ {name} ê²°ì„ ì²˜ë¦¬ë¨! (ë§ˆê°ì‹œê°„ ì´ˆê³¼ - {time_str})")
            
            # CSV íŒŒì¼ì— ê¸°ë¡
            with open(self.attendance_file, 'a', newline='', encoding='utf-8') as file:
                writer = csv.writer(file)
                writer.writerow([name, time_str, date_str, status])
            
            self.all_checked.add(name)
            self.update_real_time_display()
    
    def get_unchecked_members(self):
        """ì•„ì§ ì²´í¬ë˜ì§€ ì•Šì€ ì‚¬ëŒë“¤ ë°˜í™˜"""
        all_members = set(self.known_names)
        unchecked_members = all_members - self.all_checked
        return list(unchecked_members)
    
    def update_real_time_display(self):
        """ì‹¤ì‹œê°„ ì¶œì„ í˜„í™© ì—…ë°ì´íŠ¸"""
        current_time = time.time()
        # 5ì´ˆë§ˆë‹¤ ë˜ëŠ” ìƒˆë¡œìš´ ì¶œì„ì´ ìˆì„ ë•Œ ì—…ë°ì´íŠ¸
        if current_time - self.last_update_time > 5 or len(self.all_checked) > 0:
            self.print_real_time_status()
            self.last_update_time = current_time
    
    def print_real_time_status(self):
        """ì‹¤ì‹œê°„ ì¶œì„ í˜„í™©ì„ ì½˜ì†”ì— ì¶œë ¥"""
        # ì½˜ì†” ì°½ ì •ë¦¬ (ì„ íƒì‚¬í•­)
        # os.system('cls' if os.name == 'nt' else 'clear')
        
        print("\n" + "="*70)
        print("ğŸ“Š ì‹¤ì‹œê°„ ì¶œì„ í˜„í™©")
        print("="*70)
        
        total_count = len(self.known_names)
        checked_count = len(self.all_checked)
        unchecked_members = self.get_unchecked_members()
        
        # ì „ì²´ í˜„í™©
        print(f"ì „ì²´: {total_count}ëª… | í™•ì¸ì™„ë£Œ: {checked_count}ëª… | ë¯¸í™•ì¸: {len(unchecked_members)}ëª…")
        print("-" * 70)
        
        # ì¶œì„ì (ì •ì‹œ)
        if self.present_members:
            print(f"âœ… ì¶œì„ ({len(self.present_members)}ëª…): {', '.join(sorted(self.present_members))}")
        else:
            print("âœ… ì¶œì„ (0ëª…): -")
        
        # ì§€ê°ì
        if self.late_members:
            print(f"âš ï¸  ì§€ê° ({len(self.late_members)}ëª…): {', '.join(sorted(self.late_members))}")
        else:
            print("âš ï¸  ì§€ê° (0ëª…): -")
        
        # ê²°ì„ì (ë§ˆê° í›„ ì¶œì„)
        if self.absent_members:
            print(f"âŒ ê²°ì„ ({len(self.absent_members)}ëª…): {', '.join(sorted(self.absent_members))}")
        else:
            print("âŒ ê²°ì„ (0ëª…): -")
        
        # ë¯¸í™•ì¸ì
        current_status = self.get_current_status()
        if unchecked_members:
            if current_status == "absent_time":
                print(f"ğŸ”´ ë¯¸ì¶œì„ì-ê²°ì„ì²˜ë¦¬ì˜ˆì • ({len(unchecked_members)}ëª…): {', '.join(sorted(unchecked_members))}")
            else:
                print(f"â³ ë¯¸í™•ì¸ì ({len(unchecked_members)}ëª…): {', '.join(sorted(unchecked_members))}")
        else:
            print("â³ ë¯¸í™•ì¸ì (0ëª…): -")
        
        # í˜„ì¬ ì‹œê°„ ì •ë³´
        current_time = datetime.datetime.now().strftime("%H:%M:%S")
        status_messages = {
            "attendance_time": f"ğŸŸ¢ í˜„ì¬ ì¶œì„ ì‹œê°„ëŒ€ (~ {self.attendance_deadline})",
            "late_time": f"ğŸŸ¡ í˜„ì¬ ì§€ê° ì‹œê°„ëŒ€ ({self.attendance_deadline} ~ {self.late_deadline})",
            "absent_time": f"ğŸ”´ ì¶œì„ ë§ˆê° ì¢…ë£Œ ({self.late_deadline} ì´í›„)"
        }
        print(f"\nğŸ• í˜„ì¬ ì‹œê°„: {current_time}")
        print(f"{status_messages[current_status]}")
        print(f"â³ {self.get_time_remaining()}")
        print("="*70)
    
    def show_attendance_summary(self):
        """ì¶œì„ í˜„í™© ìš”ì•½ í‘œì‹œ"""
        print("\n" + "="*70)
        print("ğŸ“‹ ìµœì¢… ì¶œì„ í˜„í™© ìš”ì•½")
        print("="*70)
        
        total_count = len(self.known_names)
        checked_count = len(self.all_checked)
        unchecked_members = self.get_unchecked_members()
        current_status = self.get_current_status()
        
        print(f"ì´ ë™ì•„ë¦¬ì›: {total_count}ëª…")
        print(f"ì¶œì„ ì²´í¬ ì™„ë£Œ: {checked_count}ëª…")
        print(f"ë¯¸í™•ì¸: {len(unchecked_members)}ëª…")
        print("-" * 70)
        
        # ìµœì¢… í†µê³„
        print(f"âœ… ì¶œì„: {len(self.present_members)}ëª…")
        print(f"âš ï¸  ì§€ê°: {len(self.late_members)}ëª…") 
        print(f"âŒ ê²°ì„: {len(self.absent_members)}ëª…")
        
        # ìƒì„¸ ëª…ë‹¨
        if self.present_members:
            print(f"\nâœ… ì¶œì„ì: {', '.join(sorted(self.present_members))}")
        
        if self.late_members:
            print(f"âš ï¸  ì§€ê°ì: {', '.join(sorted(self.late_members))}")
            
        if self.absent_members:
            print(f"âŒ ê²°ì„ì(ë§ˆê°í›„ì¶œì„): {', '.join(sorted(self.absent_members))}")
        
        if unchecked_members:
            if current_status == "absent_time":
                print(f"ğŸ”´ ë¯¸ì¶œì„ì(ê²°ì„ì²˜ë¦¬): {', '.join(sorted(unchecked_members))}")
                # ì§€ê° ë§ˆê° ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ë¯¸ì¶œì„ìë¥¼ CSVì— ê²°ì„ìœ¼ë¡œ ê¸°ë¡
                self.mark_absent_members(unchecked_members)
            else:
                print(f"â³ ë¯¸í™•ì¸ì: {', '.join(sorted(unchecked_members))}")
        
        print("="*70)
    
    def mark_absent_members(self, absent_members):
        """ë¯¸ì¶œì„ìë¥¼ CSVì— ê²°ì„ìœ¼ë¡œ ê¸°ë¡"""
        now = datetime.datetime.now()
        date_str = now.strftime("%Y-%m-%d")
        
        with open(self.attendance_file, 'a', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            for member in absent_members:
                if member not in self.all_checked:  # ì¤‘ë³µ ë°©ì§€
                    writer.writerow([member, "-", date_str, "ê²°ì„"])
    
    def deadline_monitor(self):
        """ë§ˆê° ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìŠ¤ë ˆë“œ"""
        while self.running:
            current_status = self.get_current_status()
            
            # ì¶œì„ ë§ˆê° ì•Œë¦¼
            if not self.attendance_deadline_passed and current_status != "attendance_time":
                self.attendance_deadline_passed = True
                print(f"\nâ° ì¶œì„ ë§ˆê°ì‹œê°„({self.attendance_deadline})ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤!")
                print(f"ğŸŸ¡ ì§€ê° ì‹œê°„ëŒ€ ì‹œì‘ - {self.late_deadline}ê¹Œì§€ ì§€ê°ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.")
                self.print_real_time_status()
            
            # ì§€ê° ë§ˆê° ì•Œë¦¼
            if not self.late_deadline_passed and current_status == "absent_time":
                self.late_deadline_passed = True
                print(f"\nğŸš¨ ì§€ê° ë§ˆê°ì‹œê°„({self.late_deadline})ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤!")
                print("ğŸ”´ ì´ì œë¶€í„° ì¶œì„ ì²´í¬ ì‹œ ê²°ì„ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.")
                self.print_real_time_status()
            
            # 10ì´ˆë§ˆë‹¤ ì‹¤ì‹œê°„ í˜„í™© ì—…ë°ì´íŠ¸
            self.update_real_time_display()
            time.sleep(10)
    
    def key_listener(self):
        """í‚¤ ì…ë ¥ì„ ê°ì§€í•˜ëŠ” ìŠ¤ë ˆë“œ"""
        while self.running:
            try:
                user_input = input().strip().lower()
                if user_input == "":  # Enter í‚¤
                    self.key_pressed = True
                    break
                elif user_input == "status":  # í˜„ì¬ ìƒí™© í™•ì¸
                    self.print_real_time_status()
                elif user_input == "time":  # ì‹œê°„ ì •ë³´
                    current_time = datetime.datetime.now().strftime("%H:%M:%S")
                    print(f"\nğŸ• í˜„ì¬ ì‹œê°„: {current_time}")
                    print(f"â³ {self.get_time_remaining()}")
                elif user_input == "summary":  # ìµœì¢… ìš”ì•½
                    self.show_attendance_summary()
                elif user_input == "help":  # ë„ì›€ë§
                    print("\nğŸ“– ëª…ë ¹ì–´:")
                    print("  Enter     - í”„ë¡œê·¸ë¨ ì¢…ë£Œ")
                    print("  status    - ì‹¤ì‹œê°„ ì¶œì„ í˜„í™©")
                    print("  time      - í˜„ì¬ ì‹œê°„ ë° ë‚¨ì€ ì‹œê°„")
                    print("  summary   - ìµœì¢… ì¶œì„ ìš”ì•½")
                    print("  help      - ì´ ë„ì›€ë§ í‘œì‹œ")
            except:
                break
    
    def run(self):
        """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
        if not self.known_names:
            print("ë“±ë¡ëœ ì–¼êµ´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        # ì¹´ë©”ë¼ ì´ˆê¸°í™”
        self.cap = cv2.VideoCapture(0)
        if not self.cap.isOpened():
            print("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        print("ğŸ¯ ì‹¤ì‹œê°„ ì–¼êµ´ ì¸ì‹ ì¶œì„ ì²´í¬ ì‹œìŠ¤í…œ ì‹œì‘!")
        print(f"ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ: {datetime.date.today()}")
        print(f"â³ {self.get_time_remaining()}")
        print("\nğŸ’¡ ëª…ë ¹ì–´:")
        print("  Enter     - í”„ë¡œê·¸ë¨ ì¢…ë£Œ")
        print("  status    - ì‹¤ì‹œê°„ ì¶œì„ í˜„í™©")
        print("  time      - ì‹œê°„ ì •ë³´")
        print("  summary   - ìµœì¢… ì¶œì„ ìš”ì•½")
        print("  help      - ë„ì›€ë§ í‘œì‹œ")
        print("-" * 50)
        
        # ì´ˆê¸° í˜„í™© ì¶œë ¥
        self.print_real_time_status()
        
        self.running = True
        
        # ë§ˆê° ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìŠ¤ë ˆë“œ ì‹œì‘
        deadline_thread = threading.Thread(target=self.deadline_monitor, daemon=True)
        deadline_thread.start()
        
        # í‚¤ ì…ë ¥ ê°ì§€ ìŠ¤ë ˆë“œ ì‹œì‘
        key_thread = threading.Thread(target=self.key_listener, daemon=True)
        key_thread.start()
        
        # ì–¼êµ´ ê°ì§€ ì²˜ë¦¬ ì†ë„ í–¥ìƒì„ ìœ„í•œ ë³€ìˆ˜
        process_this_frame = True
        
        while self.running and not self.key_pressed:
            ret, frame = self.cap.read()
            if not ret:
                print("ì¹´ë©”ë¼ì—ì„œ í”„ë ˆì„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                break
            
            # ì²˜ë¦¬ ì†ë„ í–¥ìƒì„ ìœ„í•´ ë§¤ í”„ë ˆì„ë§ˆë‹¤ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            if process_this_frame:
                # í”„ë ˆì„ í¬ê¸°ë¥¼ ì¤„ì—¬ì„œ ì²˜ë¦¬ ì†ë„ í–¥ìƒ
                small_frame = cv2.resize(frame, (0, 0), fx=0.25, fy=0.25)
                rgb_small_frame = cv2.cvtColor(small_frame, cv2.COLOR_BGR2RGB)
                
                # ì–¼êµ´ ìœ„ì¹˜ì™€ ì¸ì½”ë”© ì°¾ê¸°
                face_locations = face_recognition.face_locations(rgb_small_frame)
                face_encodings = face_recognition.face_encodings(rgb_small_frame, face_locations)
                
                face_names = []
                for face_encoding in face_encodings:
                    # ì•Œë ¤ì§„ ì–¼êµ´ê³¼ ë¹„êµ
                    matches = face_recognition.compare_faces(self.known_encodings, face_encoding)
                    name = "Unknown"
                    
                    # ê°€ì¥ ê°€ê¹Œìš´ ì–¼êµ´ ì°¾ê¸°
                    face_distances = face_recognition.face_distance(self.known_encodings, face_encoding)
                    best_match_index = np.argmin(face_distances)
                    
                    if matches[best_match_index] and face_distances[best_match_index] < 0.6:
                        name = self.known_names[best_match_index]
                        # ì¶œì„ ì²´í¬
                        self.mark_attendance(name)
                    
                    face_names.append(name)
            
            process_this_frame = not process_this_frame
            
            # ê²°ê³¼ë¥¼ ì›ë³¸ í”„ë ˆì„ì— í‘œì‹œ
            for (top, right, bottom, left), name in zip(face_locations, face_names):
                # ì¢Œí‘œë¥¼ ì›ë³¸ í¬ê¸°ë¡œ ë³µì›
                top *= 4
                right *= 4
                bottom *= 4
                left *= 4
                
                # ì–¼êµ´ ì£¼ë³€ì— ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
                color = (0, 255, 0) if name != "Unknown" else (0, 0, 255)
                cv2.rectangle(frame, (left, top), (right, bottom), color, 2)
                
                # ì´ë¦„ í‘œì‹œë¥¼ ìœ„í•œ ë°°ê²½ ì‚¬ê°í˜•
                cv2.rectangle(frame, (left, bottom - 35), (right, bottom), color, cv2.FILLED)
                
                # ì´ë¦„ í…ìŠ¤íŠ¸ í‘œì‹œ (ì˜ë¬¸ë§Œ, í•œê¸€ ì´ë¦„ì´ë©´ ì•„ë˜ì—ì„œ Pillowë¡œ í‘œì‹œë¨)
                font = cv2.FONT_HERSHEY_DUPLEX
                cv2.putText(frame, name, (left + 6, bottom - 6), font, 0.8, (255, 255, 255), 1)
            
            # í™”ë©´ ì¢Œì¸¡ì— ì‹¤ì‹œê°„ í†µê³„ í‘œì‹œ (Pillowë¡œ í•œê¸€ ì§€ì›)
            info_y = 30
            font_size = 24

            # ì „ì²´ ì¶œì„ í˜„í™©
            total_text = f"ì „ì²´: {len(self.all_checked)}/{len(self.known_names)}"
            frame = draw_text_with_pil(frame, total_text, (10, info_y), font_path, font_size, (255,255,255))
            info_y += 30

            # ì¶œì„ì ìˆ˜
            present_text = f"ì¶œì„: {len(self.present_members)}"
            frame = draw_text_with_pil(frame, present_text, (10, info_y), font_path, font_size, (0,255,0))
            info_y += 25

            # ì§€ê°ì ìˆ˜
            late_text = f"ì§€ê°: {len(self.late_members)}"
            frame = draw_text_with_pil(frame, late_text, (10, info_y), font_path, font_size, (0,255,255))
            info_y += 25

            # ê²°ì„ì ìˆ˜ (ë§ˆê° í›„ ì¶œì„)
            absent_text = f"ê²°ì„: {len(self.absent_members)}"
            frame = draw_text_with_pil(frame, absent_text, (10, info_y), font_path, font_size, (0,0,255))
            info_y += 25

            # ë¯¸í™•ì¸ì ìˆ˜
            unchecked_count = len(self.get_unchecked_members())
            unchecked_text = f"ë¯¸í™•ì¸: {unchecked_count}"
            frame = draw_text_with_pil(frame, unchecked_text, (10, info_y), font_path, font_size, (128,128,128))
            info_y += 30

            # í˜„ì¬ ì‹œê°„ëŒ€ í‘œì‹œ
            current_status = self.get_current_status()
            status_colors = {
                "attendance_time": (0, 255, 0),  # ì´ˆë¡ - ì¶œì„
                "late_time": (0, 255, 255),      # ë…¸ë‘ - ì§€ê°
                "absent_time": (0, 0, 255)       # ë¹¨ê°• - ê²°ì„
            }
            status_texts = {
                "attendance_time": "ì¶œì„ ì‹œê°„",
                "late_time": "ì§€ê° ì‹œê°„",
                "absent_time": "ë§ˆê° ì¢…ë£Œ"
            }
            status_color = status_colors[current_status]
            status_display = status_texts[current_status]
            frame = draw_text_with_pil(frame, f"í˜„ì¬: {status_display}", (10, info_y), font_path, font_size, status_color)
            info_y += 25

            # ë‚¨ì€ ì‹œê°„
            time_remaining = self.get_time_remaining()
            time_color = (0, 0, 255) if "ë§ˆê°" in time_remaining else (255, 255, 0)
            frame = draw_text_with_pil(frame, time_remaining, (10, info_y), font_path, font_size-4, time_color)
            info_y += 25

            # ëª…ë ¹ì–´ ì•ˆë‚´
            frame = draw_text_with_pil(frame, "ì½˜ì†”: status,summary,help", (10, info_y), font_path, font_size-8, (255,255,255))

            # í™”ë©´ì— í‘œì‹œ
            cv2.imshow('Real-time Face Attendance System', frame)
            
            # ESC í‚¤ë¡œë„ ì¢…ë£Œ ê°€ëŠ¥
            if cv2.waitKey(1) & 0xFF == 27:  # ESC key
                break
        
        # ì •ë¦¬ ë° ìµœì¢… ìš”ì•½
        self.cleanup()
        self.show_attendance_summary()
    
    def cleanup(self):
        """ë¦¬ì†ŒìŠ¤ ì •ë¦¬"""
        self.running = False
        if self.cap:
            self.cap.release()
        cv2.destroyAllWindows()
        print(f"\nğŸ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")

def main():
    # ì„¤ì • - ì›í•˜ëŠ” ë§ˆê° ì‹œê°„ë“¤ì„ ì—¬ê¸°ì„œ ë³€ê²½í•˜ì„¸ìš” (HH:MM í˜•ì‹)
    attendance_deadline = "02:30"  # ì¶œì„ ë§ˆê° ì‹œê°„
    late_deadline = "3:00"        # ì§€ê° ë§ˆê° ì‹œê°„ (ì´í›„ëŠ” ê²°ì„)
    
    print("ğŸ¯ ì‹¤ì‹œê°„ ì–¼êµ´ ì¸ì‹ ì¶œì„ ì²´í¬ ì‹œìŠ¤í…œ")
    print("="*50)
    print(f"âœ… ~ {attendance_deadline}: ì¶œì„")
    print(f"âš ï¸  {attendance_deadline} ~ {late_deadline}: ì§€ê°")
    print(f"âŒ {late_deadline} ~: ê²°ì„")
    print("="*50)
    
    # ì¶œì„ ì‹œìŠ¤í…œ ì‹¤í–‰
    system = AttendanceSystem(
        attendance_deadline=attendance_deadline,
        late_deadline=late_deadline
    )
    system.run()

if __name__ == "__main__":
    main()
